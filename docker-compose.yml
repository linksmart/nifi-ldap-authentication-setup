version: "3"

services:

  ldap:
    build: ./ldap
    image: monsoon/ldap
    container_name: monsoon_ldap
    restart: always
    ports:
      - 389:389
    environment:
      - LDAP_ADMIN_PASSWORD=${LDAP_ADMIN_PASSWORD}
      - LDAP_ORGANISATION=${LDAP_ORGANISATION}
      - LDAP_DOMAIN=${LDAP_DOMAIN}
    healthcheck:
      test: ["CMD-SHELL", "/healthcheck.sh"]
      interval: 30s
      timeout: 10s
      retries: 5
    volumes:
      - ldap_volume:/var/lib/ldap
      - ldap_conf_volume:/etc/ldap/slapd.d
    networks:
      - frontend

  nifi:
    build: ./ldap
    image: monsoon/nifi
    container_name: monsoon_nifi
    restart: always
    ports:
      - 8443:8443
    environment:
      - AUTH=ldap
      - KEYSTORE_PATH=/opt/secrets/keystore.jks
      - KEYSTORE_TYPE=JKS
      - KEYSTORE_PASSWORD=monsoon
      - TRUSTSTORE_PATH=/opt/secrets/truststore.jks
      - TRUSTSTORE_PASSWORD=monsoon
      - TRUSTSTORE_TYPE=JKS
      - INITIAL_ADMIN_IDENTITY=${NIFI_INITIAL_ADMIN_IDENTITY}
      - LDAP_AUTHENTICATION_STRATEGY=SIMPLE
      - LDAP_MANAGER_DN=${NIFI_LDAP_MANAGER_DN}
      - LDAP_MANAGER_PASSWORD=${NIFI_LDAP_MANAGER_PASSWORD}
      - LDAP_USER_SEARCH_BASE=${NIFI_LDAP_USER_SEARCH_BASE}
      - LDAP_USER_SEARCH_FILTER=uid={0}
      - LDAP_IDENTITY_STRATEGY=USE_DN
      - LDAP_URL=ldap://ldap:389
      - NIFI_WEB_PROXY_HOST=ucc-ipc-0:8443
      - NIFI_WEB_HTTP_HOST=ucc-ipc-0
      - NIFI_REMOTE_INPUT_HOST=ucc-ipc-0
    volumes:
      - nifi_conf_volume:/opt/nifi/nifi-1.6.0/conf
      - nifi_logs_volume:/opt/nifi/nifi-1.6.0/logs
      - nifi_database_volume:/opt/nifi/nifi-1.6.0/database_repository
      - nifi_flowfile_volume:/opt/nifi/nifi-1.6.0/flowfile_repository
      - nifi_content_volume:/opt/nifi/nifi-1.6.0/content_repository
      - nifi_provenance_volume:/opt/nifi/nifi-1.6.0/provenance_repository
    networks:
      - frontend

volumes:
  ldap_volume:
  ldap_conf_volume:
  nifi_conf_volume:
  nifi_logs_volume:
  nifi_database_volume:
  nifi_flowfile_volume:
  nifi_content_volume:
  nifi_provenance_volume:
 
networks:
  frontend:
